<UserControl x:Class="CellManager.Views.ScheduleBuilderView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d"
             d:DesignHeight="450" d:DesignWidth="800">
    <UserControl.Resources>
        <CollectionViewSource x:Key="GroupedProfiles" Source="{Binding ProfileLibrary}">
            <CollectionViewSource.GroupDescriptions>
                <PropertyGroupDescription PropertyName="Type" />
            </CollectionViewSource.GroupDescriptions>
        </CollectionViewSource>
    </UserControl.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <StatusBar Grid.Row="0" Margin="10">
            <WrapPanel>
                <TextBlock Text="{Binding SelectedCell.DisplayNameAndId}" Margin="0,0,16,4"/>
                <TextBlock Text="{Binding SelectedCell.LastUpdated, StringFormat='Updated: {0:yyyy-MM-dd HH:mm:ss}'}" Margin="0,0,16,4"/>
                <TextBlock Text="{Binding SelectedCell.Manufacturer, StringFormat='Manufacturer: {0}'}" Margin="0,0,16,4"/>
                <TextBlock Text="{Binding SelectedCell.CellType, StringFormat='Type: {0}'}" Margin="0,0,16,4"/>
                <TextBlock Text="{Binding SelectedCell.SerialNumber, StringFormat='SN: {0}'}" Margin="0,0,0,4"/>
            </WrapPanel>
        </StatusBar>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Grid Grid.Column="0" Margin="5">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="2*"/>
                    <RowDefinition Height="3*"/>
                </Grid.RowDefinitions>

                <StackPanel Grid.Row="0" Orientation="Horizontal">
                    <Button Content="New" Command="{Binding NewScheduleCommand}" Margin="0,0,5,0"/>
                    <Button Content="Delete" Command="{Binding DeleteScheduleCommand}" Margin="0,0,5,0"/>
                </StackPanel>

                <ListView Grid.Row="1" ItemsSource="{Binding Schedules}" SelectedItem="{Binding SelectedSchedule}" Margin="0,5,0,5">
                    <ListView.View>
                        <GridView>
                            <GridViewColumn Header="Name" DisplayMemberBinding="{Binding Name}" Width="150"/>
                            <GridViewColumn Header="Profiles">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding TestProfileIds.Count}"/>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                        </GridView>
                    </ListView.View>
                </ListView>

                <ListBox x:Name="ProfileList" Grid.Row="2" Margin="0,5,0,0"
                         ItemsSource="{Binding Source={StaticResource GroupedProfiles}}"
                         DisplayMemberPath="DisplayNameAndId"
                         PreviewMouseLeftButtonDown="ProfileList_PreviewMouseLeftButtonDown"
                         PreviewMouseMove="ProfileList_PreviewMouseMove"
                         Style="{StaticResource DenseListBox}">
                    <ListBox.GroupStyle>
                        <GroupStyle>
                            <GroupStyle.HeaderTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Name}" FontWeight="Bold" Margin="0,5,0,0"/>
                                </DataTemplate>
                            </GroupStyle.HeaderTemplate>
                        </GroupStyle>
                    </ListBox.GroupStyle>
                </ListBox>
            </Grid>

            <Grid Grid.Column="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <StackPanel Orientation="Horizontal" Margin="5">
                    <TextBlock Text="Name:" VerticalAlignment="Center"/>
                    <TextBox Text="{Binding ScheduleName, UpdateSourceTrigger=PropertyChanged}"
                             Width="150" Margin="5,0"/>
                    <Button Content="Save" Command="{Binding SaveScheduleCommand}" Margin="5,0"/>
                    <Button Content="Clear" Command="{Binding ClearScheduleCommand}" Margin="5,0"/>
                </StackPanel>

                <Grid Grid.Row="1">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <TextBlock Text="{Binding TotalEstimatedDuration, StringFormat='Total Duration: {0:hh\\:mm\\:ss}', TargetNullValue='Total Duration: Error'}"
                               Margin="5"/>

                    <ItemsControl x:Name="Timeline" Grid.Row="1"
                                  ItemsSource="{Binding WorkingSchedule}"
                                  AllowDrop="True"
                                  PreviewMouseLeftButtonDown="ScheduleList_PreviewMouseLeftButtonDown"
                                  PreviewMouseMove="ScheduleList_PreviewMouseMove"
                                  Drop="ScheduleList_Drop"
                                  DragOver="ScheduleList_DragOver"
                                  DragLeave="ScheduleList_DragLeave"
                                  Margin="5">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border BorderBrush="{DynamicResource {x:Static SystemColors.ControlDarkBrushKey}}" BorderThickness="1" Margin="2" Padding="5">
                                    <StackPanel>
                                        <TextBlock Text="{Binding DisplayNameAndId}" FontWeight="Bold"/>
                                        <TextBlock Text="{Binding StartTime, StringFormat='Start: {0:hh\\:mm\\:ss}'}"/>
                                        <TextBlock Text="{Binding EndTime, StringFormat='End: {0:hh\\:mm\\:ss}'}"/>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <ListBox x:Name="ScheduleList" Grid.Row="2"
                             ItemsSource="{Binding WorkingSchedule}"
                             AllowDrop="True"
                             PreviewMouseLeftButtonDown="ScheduleList_PreviewMouseLeftButtonDown"
                             PreviewMouseMove="ScheduleList_PreviewMouseMove"
                             Drop="ScheduleList_Drop"
                             DragOver="ScheduleList_DragOver"
                             DragLeave="ScheduleList_DragLeave"
                             Margin="5">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="{Binding DisplayNameAndId}" VerticalAlignment="Center" Width="200"/>
                                    <TextBlock Text="{Binding EstimatedDuration, StringFormat='Duration: {0:hh\\:mm\\:ss}', TargetNullValue='Duration: Error'}"
                                               Margin="5,0" VerticalAlignment="Center"/>
                                    <Button Content="Remove"
                                            Command="{Binding DataContext.RemoveProfileCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                            CommandParameter="{Binding}" Margin="5,0"/>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>

                <TextBox Grid.Row="2" Margin="5" Height="60" AcceptsReturn="True"
                         Text="{Binding Notes}"/>
            </Grid>
        </Grid>
    </Grid>
</UserControl>

